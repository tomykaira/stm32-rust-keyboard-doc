「はじめに」で自分でキーボード基板を引くのが主題のひとつであると説明しました。
この章では実際にどのようにしてキーボードハードウェアを製造するべきだったかを解説します。
実際にこのとおり手順よくできたわけではなく、多くの回り道と失敗がありました。
たんなる手順書にとどまらず、今後STM32をつかった自作キーボード基板を設計する人ができるだけスムーズに成功できるためのヒントを書くようにしました。

なお、かならずしもRust Firmwareを動かすために自分で基板をつくる必要はありません。
ブレッドボードを使ったり、既存のキーボード基板をつかってもよいです。
ハードウェアの章とソフトウェアの章は独立の問題をあつかっています。

# 部品の調達

キーボード基板を作ろうと思ったとき、KiCADなど基板を開くところから始めるのはせっかちです。
KiCADで回路を組み立てる前にどんな構成にするか決めるほうがよいです。
とくにMCUを自由に選定すると選択肢があまりに多く、またどれを使うかによって必要な周辺パーツもかわってきます。
まずやりたいことを整理し、MCUを決定するところから始めるのが余計なパーツを買って後悔しないコツです。

MCUを選び始める前に、価格についての考えを示します。
MCUの価格の許容範囲は生産数で変わります。
千台売る予定があるのであれば300円のMCUと200円のMCUはそこそこの違いになりますが、5個であれば無視できます。
基板1枚の製造コストはおおむね4ドルから5ドル(5枚で20ドルから30ドル)のようです。
また周辺部品を使い切れる分くらい購入するとしめて200円から500円くらいになります。
これらと比較してMCUは500円以内程度であれば機能リッチでトラブルが起きづらいものを選択する方針としました。
他の部分でも、価格よりはリスクや手間をケチるようにしています。
わたしたちの時間もタダではないし、ミスってやりなおしになったらそのぶん追加部品の費用もかかります。
どれくらいのパーツをつかうかは自由ですが、あらかじめどれくらいの幅におさめるか決め、値段にひきづられないのが即決のコツです。

やりたいことをリストアップしてみましょう。
キーボードは通常コンピュータなどUSBホストにUSB接続します。
USB接続機能が必要です。
USB接続は、原理的にはGPIOをつかってソフトウェア制御で実現できますが、おすすめしません。
USB機能をサポートしているハードウェアを選択するのが無難です。

次にキー数を見積もります。キーマトリクス方式の場合はGPIOがキー数のおよそ平方根ぶん、GPIO直結の場合はキー数分必要です。
どんなキーボードレイアウトにするかおおまかに想像し、必要なGPIO数があるMCUを選びます。

左右分離にするならば左右通信のための機能が必要です。
よく使われるのはI2CやUART、USARTです。
これもMCUがハードウェアサポートしている方がよいです。

わたしがとった構成はUSBとI2Cだけのシンプルなものですが、PS/2接続をつかったりアナログピンで静電容量を取ることももちろん可能です。
そのために必要な機能やピン数をしらべましょう。
Bluetoothをつかうこともできます。日本国内で使うならば技適準拠したMCUであり、かつ自分が実装したものも準拠するよう考慮する必要があります。

通信をソフトウェアエミュレーションするべきでない理由ですが、タイミングが非常に厄介になるからです。
たとえばUARTであれば一定の間隔で入力を読み取ったり出力を切り替える必要があります。
ソフトウェア実装するとこの間隔が非常にあやしくなりやすいです。1つだけの通信を実装するならまだしも、USBとI2Cなど複数の通信を実装するとタイミング制御が複雑になり、ファームウェアの実装難度が不必要にあがってしまいます。
たしかにハードウェア機能をつかうためにマニュアルを読むのも億劫ですが、少ないデバッグ時間で安定した動作を得るためにハードウェア機能を使うことを強くおすすめします。

最後に、ぜひおすすめしたいのがデバッグサポートとDFUです。
デバッグサポートとは特定のピンに外部ハードウェアを接続し、コンピュータなどから動作状況を調べられる機能です。
コンピュータ内のプログラミングで使うデバッガがそのまま開発中のハードウェアでも使えるイメージです。
本格的なデバッグツールは高価ですが、ST-Linkの機能を実装したノーブランド品なら500円程度で購入できます。
ハードウェアを上からながめていても何もわかりませんので、なんらか中身を見る方法があると安心です。
デバッグサポートはほとんどのMCUに存在します。
デバッグサポートのピンを空けておいても他の用途に使えることを確認しましょう。

DFU(USB DFU, Device Firmware Upgrade)はキーボードファームウェアをUSBで書き換える機能です。
わたしも調べる前はそんなの当然できるでしょと思っていましたが、STM32の、とくにMCU単体のものはできないものが多数あります。
有名どころでは、BluePillはできません。
STM32では上述のデバッガなどをつかって書き込むほうが一般的で、DFUサポートは限定的です。

また、非常に罠なのですが、MCUによってはDFUサポートがあると書いてあるにもかかわらず、使えないものがあります。
STM32F105/107がそうです。STM32F1シリーズは安価で販売している所も多いので、使えれば第一選択になるのですが、チップの版によっては使えません。
[STのAN2606](https://www.st.com/resource/en/application_note/cd00167594-stm32-microcontroller-system-memory-boot-mode-stmicroelectronics.pdf)から引用します。

> 14.3.2 Bootloader unavailability on STM32F105xx/STM32F107xx devices with date code lower than 937
> (中略)
> Workaround
> • For 64-pin packages
> None. The bootloader cannot be used. 

ひどい！この罠はしっかり踏みました。ひどすぎる。
いいかげんに購入したらどの版の石がくるかわからないので、こういうのは避けましょう。
AN2606はDFUサポートの優秀なMCUをみつくろうためにとても便利です。
各MCUのブートシーケンスが図示されているので、条件達成が容易そうなものをえらびましょう。

![STM32F105/107のブートローダーセレクション](https://i.ibb.co/y83vxtt/an2606-fig17.png)

たとえばこの図では、DFUにHSEが必要なことがわかります。
HSEとは外部クロックソースです(内部クロックソースがHSI)。
すなわちSTM32F105/107でDFUをつかうには発振子も実装する必要があります。
HSIでもDFUが使えるもののほうがいいですね。

コアの種類にも注意が必要です。
STM32はST社が制作する32-bit Arm Cortex-Mプロセッサコアを搭載したMCUの意味ですが、Cortex-Mのなかにも種類があります。
Cortex-M0からはじまり、M0+、M1、M3とつづきます。
おおむね数字がでかいほうが強いです。
離散フーリエ変換でライトをいいかんじに光らせたいとか特殊な希望がある場合はそれに適った性能のコアを選択しましょう。
またM0、M0+、M1はARMv6という古いインストラクションセットを採用しており、レジスタも端折られているので、ファームウェア実装で苦労します。
自力で書く分はともかく、ライブラリが動かないとかなり大変な目に遭うのでCortex-M3以上を搭載したものがオススメです。
この点がなければSTM32F072もよろしいのですが。
よりしょうもない話ですが、Rustで書くならば、HAL(Hardware Abstraction Layer)が実装されているか、更新されているかも気にする必要がありました。
[stm32-rs](https://github.com/stm32-rs)では製品ラインごとにHALをべつべつで実装していて、微妙にnaming conventionもずれていたりします。
F系が充実していますが後述の理由で回路が複雑になるので、ほかでマシそうなやつを探しました。
使いたいライブラリがあれば、対応状況を確認してください。

やりたいことと必要なものがきまったら実際の[MCU一覧](https://www.st.com/en/microcontrollers-microprocessors/stm32-32-bit-arm-cortex-mcus.html)をみて選んでいきます。
以上でとりあげたのは次の項目です。

- USB DFU
- USB device
- I2Cなど
- キースイッチぶんのGPIO
- デバッグサポート(SWDIO,SWCLK)
- 演算性能

ほかに物理ピン数、パッケージ形式なども気にする必要があります。
手ハンダするならリードのあるもの(LQFP)を選択する必要があります。裏面パッドははんだゴテではんだ付けできないので詰みます。
物理ピン数は多すぎるとはんだ付けが面倒です。少なすぎるとGPIOが不足します。
RAMサイズ、Flashサイズはさほど気にする必要はないかと思います。複雑なことをしてRAM、Flashがたくさん必要なのでなければ入手性を優先してよいでしょう。

驚くべきことに、USB DFUの条件が一番厳しいのでこれで絞って、のこりの条件を満たすものを見つけるのがよいです。
STM32Fxxx系はすべてHSEを要求します。オシレータをのせたり回路を調べるのは面倒でしょう。
STM32G4xx、H4xx、H7xx、L4xx、L5xxはどうもHSIでのDFUをサポートしているようです。
正確にひとつずつみてはいないので、ねんのためAN2606で確認してください。

なおUSB DFUを要求せず、かわりにデバッガ(ST-Link等)相当の機能を基板上に実装することもできます。
NucleoなどSTM32を載せた開発ボードはたいていこのような構成になっています。
部品点数は増えますが、デバッグまでワンストップでできる利点があります。
わたしは最小部品数でやりたかったので、この方法は検討していません。

以上の条件を考え、わたしはDFUのあるなかでいちばん安そうでHALが動きそうだったSTM32L412を利用しました。
もちろんどれでもよいですが、STM32L412はすくなくとも問題なく動いているのでオススメです。

MCUを決めたらMCUが要求する回路を調査します。

部品を決めたら回路図を作成しつつ部品を購入します。
間違いがみつかるかもしれないので発注するのは回路図や基板が書けてからのほうがいいでしょう。
しかし入手性を確認する必要もあるので、どこでなにを買うのかは先に調べたほうがよかったです。
STM32の石はポピュラーなものはAliExpressやAmazonでも販売していますが、マイナーなものはMouserやDigiKeyに発注する必要があります。
どちらも海外発送で送料がたかいですが、6,000円以上で送料無料になるのである程度まとめて、ほかの部品も一気に購入しましょう。
基板の発注数分で微妙に足らなかったらちょっと余分に買うか、送料を払うかは按配です。
配送はかなり速いです。まず基板よりは先にきます。

# 回路図の作成

# 基板の作成

# 基板の実装