# はじめに

この文書ではARMマイコンであるSTM32を自分が設計した基板に直接搭載し、Rustでファームウェアを記述して標準的な分割キーボードを作る過程で学んだことをまとめます。
「はじめての」とはわたしがはじめてやったことを意味します。
たんに流れを解説するだけではなく、背景知識や見つけたテクニック、トラブル事例にも触れ、おなじような開発を行う人がつまづかないで、たのしくキーボードを作れることを目指します。

# 目次

大項目ごとにファイルがわかれています。

- 導入
  - 開発のきっかけ
  - 謝辞
  - 連絡先
- ハードウェアの設計と実装
  - 部品の調達
  - 回路図の作成
  - 基板の作成
  - 基板の実装
- ソフトウェアの設計と実装
  - 環境構築
  - ライブラリの紹介
  - 枠組みの実装
- 基礎知識の解説
- トラブルシューティング集

# 開発のきっかけ

わたしが左右分割キーボードに触れたのは、寝た状態で作業するとき体の左右にキーボードがあったほうがいい、という考えからでした。最初に入手したのはErgodoxで、完成品を購入しました。しかし使ううちにキーボードが大きすぎる、親指まわりの配置が気にいらないなどの問題が出てきました。そこでHelixキットを購入し、組み立て、はじめて自作キーボードに触れることになります。

わたしは大学でユーザインタフェース系の研究室に所属していた時期があります。UI好きとして、自作キーボードの真髄は自分で好きなように作ることにあると考えています。個人的な課題を個人的なアプローチで解決する、そこにだれの口も挟まれる必要はないというのが楽しみです。

2020年秋の私の悩みは手の痛みでした。いろいろ配置を変えたり試行錯誤しましたが、どうもうまく改善しません。そこで狭ピッチキーボードを作ることを考えました。挟ピッチキーボードの場合、既存のキーボード基板やブレイクアウトでは幅が合わないので、独自に基板を引く必要があります。どうせ引くなら、ということで長年のファームウェアいじりの障害であったAVRマイコンも捨てようと決意しました。なぜAVRを、もっといえば安価で便利なProMicroを捨てなければいけないのか。それはQMKの使い勝手の悪さにあります。

QMKはとてもよく出来ていますが、残念ながら私の好みには合いません。QMKの課題点は

- あやしいキーボードのコードが大量に同一リポジトリにあり、なんとなく気になる
- C言語で実装されており開発効率がさほど高くない
- テストが書けない
- 言語の性質上、keyboards空間下でのカスタマイズ性が十分に高いとはいえない
- ちょいちょい外部ドライバ系など実装が完全でない場合がある

などです。これらは2020年初頭あたりの課題意識なので、いまではもっとよくなっているかもしれません。

しかしテストがかけない、C言語の2点は致命的です。技能的にC言語が書けても、よりコンパイラによるサポートの手厚い環境であればより効率的に実装できます。テストも同様で、難しいタイミング問題やステート管理などを実機で試していくのはとても骨が折れます。

通常キーボードといって想起する機能を実装する分には問題ありません。しかしQMKにもオプションとして用意されているtap danceやkey comboを実装するとなかなか大変です。QMKのkey comboはつかい物になりませんでした。またJPキーボードと認識させてUSっぽい配列にするためにはShiftをよいかんじでコントロールする必要がありますが、このような単純なことでも既にShiftが押されているか、など考え始めると状態が膨らみ、テストなしでは実装困難です。

わたしは以前よりRustに興味があり、他の用途でも使用していました。そこでキーボードもRustで書いたら堅牢で効率的に仕上がるだろうと考えました。当時RustのAVRサポートは開発中で動かすのも大変な有り様でした。対してARMはかなり充実しており、RustのベアメタルプログラミングはほぼARMでやられている印象がありました。そこでせっかく基板を引くならARMを、となりました。こうしてARM直載せ、Rustファームウェアという方針が決定し、半年以上かかる大変な工程がスタートしました。大半は部品を待っていたか、サボっていただけですが。

# 謝辞

ARMベースのハードウェアとRustをつかったファームウェアを実装するにあたり、以下の文献を大いに参考にしました。
これらがなかったら、そもそも作り始めようとすら思わなかったかもしれません。
CHOCOが手元にあったことは大きなきっかけになりましたし、keyboard-from-scratchがさっと動いたことで開発への意欲を保てました。
この場を借りてお礼を申し上げます。

- [hsgw/choco](https://github.com/hsgw/choco)
- [KOBA789/keyboard-from-scratch](https://github.com/KOBA789/keyboard-from-scratch)

# 連絡先

この文書の内容の感想、質問、やってみたけどわかんないんだけど、間違いの指摘、ビールを奢りたい、雑談などは[twitter/tomykaira_2](https://twitter.com/tomykaira_2)までどうぞ。答えないこともありますが、どんな内容でもかまいません。

感想などはぜひ`#はじめてのSTM32andRustキーボード`のハッシュタグをお使いください。