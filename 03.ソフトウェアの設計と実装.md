第三章では、第二章で扱ったハードウェアの実装を念頭に、作成した基板をキーボードとして動作させるためのソフトウェアの実装方法を紹介します。
例として第二章で取り上げた構成やMCUを使いますが、他の構成でも利用可能な情報になるよう気をつけました。
リファレンスマニュアルやデータシートを参照している箇所はそれぞれお使いのMCUの情報に読み替えてください。

# 環境構築

今後の節ではMCUプログラミングを基礎から解説していきます。
実際に手元のデバイスで実験するために先に環境構築を済ませてしまいましょう。
イマイチ原理や目的がわからない部分もあるだろうと思いますが、ガイダンスに沿ってセットアップしてみてください。

ソフトウェアはすべてLinux、macOS、Windowsで共通のものが使えます。
ダウンロード・インストール方法が異なるものは適宜読み替えてください。

## Rust

Rust言語で実装したファームウェアをコンパイルするために必要です。
[Install Rust](https://www.rust-lang.org/tools/install)の手順にそってインストールしてください。
完了後、`rustup`と`cargo`が使えることを確認してください。
`cargo`はRustのパッケージマネージャ兼ビルドシステムです。

## [cargo-binutils](https://github.com/rust-embedded/cargo-binutils)

cargoのサブコマンドを追加しdfu-utilで書き込み可能なバイナリファイルを作成するために必要です。
[ReadmeのInstallation](https://github.com/rust-embedded/cargo-binutils#installation)に従ってインストールしてください。
あとでCargoプロジェクトを作成してから`cargo objcopy`が実行できれば成功です。

## ARMターゲット

利用するMCUのアーキテクチャに対応したコードを出力するために、ターゲットを追加する必要があります。
ここで指定する引数はMCUによって異なります。
[Crate cortex_m_quickstart](https://docs.rust-embedded.org/cortex-m-quickstart/cortex_m_quickstart/#usage)によると

- Use thumbv6m-none-eabi for ARM Cortex-M0 and Cortex-M0+
- Use thumbv7m-none-eabi for ARM Cortex-M3
- Use thumbv7em-none-eabi for ARM Cortex-M4 and Cortex-M7 (no FPU support)
- Use thumbv7em-none-eabihf for ARM Cortex-M4F and Cortex-M7F (with FPU support)

という対応関係のようです。
[STM32L412](https://www.st.com/en/microcontrollers-microprocessors/stm32l412kb.html)のページに「Ultra-low-power with FPU Arm Cortex-M4 MCU 80 MHz with 128 Kbytes of Flash memory, USB」とありますので、Cortex-M4Fになります。
なおFPUとはFloating Point Unit、浮動小数点演算器です。
利用したMCUのページを確認して必要なものを次のように追加します。

```
rustup target add thumbv7m-none-eabi
```

## dfu-util

USB DFUを使ってファームウェアを書き込むために必要です。
[dfu-util公式サイト](http://dfu-util.sourceforge.net/)でバイナリが配布されています。
macOSであればhomebrewで、UbuntuなどはOSのパッケージマネージャでもインストールできます。

## openocd (ST-Link利用時のみ)

ST-Linkを利用してデバッグする場合、ホストコンピュータとST-Linkの通信に必要です。
[入手方法](http://openocd.org/getting-openocd/)を参考にインストールしてください。
Windows以外では標準的なパッケージマネージャで提供されているようです。
Windowsはコンパイル済バイナリがインターネットに転がっています。

## gdb (ST-Link利用時のみ)

ST-Linkを利用してデバッグする場合、openocdを経由してプログラムをロードしたりデバッグするのに利用します。
ホストコンピュータのアーキテクチャ用のものではなく、MCUのアーキテクチャ用のものが必要です。
[GNU Arm Embedded Toolchain Downloads](https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads)から入手できます。
また標準的なパッケージマネージャでも提供されているようです。

## 最初のプロジェクト

(TODO)

# MCUをプログラミングするとは

ソフトウェアを実装するにあたり、どんな仕組みでMCUをプログラミングできるのか理解しておくことが重要です。
コピーペーストでもHello World相当のプログラムを動かすのは簡単ですが、自分のためのキーボードを工夫するには基礎知識があったほうがよいでしょう。
この節ではリファレンスマニュアルを読んだり、プログラミングを進める時に何をやっているのか理解できるだけの背景知識をお伝えします。
やりたいこと、リファレンスマニュアルの情報、Rustのコードを対応づけ、意味がわかりやすいようにしました。
すでにコンピュータサイエンスとSoCの基礎を理解している場合は飛ばしてもかまいません。

## 最も簡単なプログラム

## プログラムを書き込む

# ライブラリの紹介
# 枠組みの実装
